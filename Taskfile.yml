version: '2'

vars:
  BUILD_DIR: build
  DOCKER_REPO: pg2000/codecommit-pr-resource

tasks:

  docker:
    desc: Build docker image under dev tag.
    cmds:
      - docker build -t {{.DOCKER_REPO}}:dev .

  build:
    desc: Build check/in/out artifacts
    cmds:
      - task: go-build
        vars: { BINARY: check }
      - task: go-build
        vars: { BINARY: in }
      - task: go-build
        vars: { BINARY: out }

  go-build:
    cmds:
      - go build -o {{.BUILD_DIR}}/{{.BINARY}}{{exeExt}} -ldflags="-s -w" -v cmd/{{.BINARY}}/main.go
    env:
      CGO_ENABLED: '0'
      GOOS: '{{OS}}'
      GOARCH: '{{ARCH}}'

  ci:
    desc: CI build and tests
    cmds:
      - task: build
      - if [ -n "$(git status --porcelain)" ];then echo "Diff in generated files and/or formatting" && exit 1; fi
    silent: true
